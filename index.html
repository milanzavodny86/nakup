<!DOCTYPE html>
<html lang="sk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Nákupníček</title>
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#059669" />
    <meta name="mobile-web-app-capable" content="yes">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body { overscroll-behavior-y: contain; -webkit-tap-highlight-color: transparent; background-color: #f9fafb; font-family: sans-serif; }
      #root:empty::before {
        content: ''; display: block; width: 40px; height: 40px; margin: 45vh auto;
        border: 4px solid #e5e7eb; border-top: 4px solid #059669; border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      .safe-top { padding-top: env(safe-area-inset-top, 2.5rem); }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "@google/genai": "https://esm.sh/@google/genai@^1.37.0",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
  <body class="bg-gray-50 text-gray-900">
    <div id="root"></div>

    <script type="text/tsx">
      import React, { useState, useEffect, useMemo } from 'https://esm.sh/react@19.0.0';
      import { createRoot } from 'https://esm.sh/react-dom@19.0.0/client';
      import * as Lucide from 'https://esm.sh/lucide-react@0.460.0';
      import { GoogleGenAI } from "https://esm.sh/@google/genai@1.37.0";

      // --- Konštanty ---
      const DEFAULT_CATEGORIES = ['Ovocie a zelenina', 'Pečivo', 'Mliečne výrobky', 'Mäso a údeniny', 'Trvanlivé potraviny', 'Nápoje', 'Drogéria', 'Ostatné'];
      const INITIAL_DATA = [
        { id: '1', name: 'Mlieko', category: 'Mliečne výrobky', status: 'needed', quantity: '2ks' },
        { id: '2', name: 'Chlieb', category: 'Pečivo', status: 'needed', quantity: '1ks' }
      ];

      // --- Hlavná aplikácia ---
      function App() {
        const [activeTab, setActiveTab] = useState('shopping');
        const [products, setProducts] = useState(() => {
          const saved = localStorage.getItem('sn-data');
          return saved ? JSON.parse(saved) : INITIAL_DATA;
        });
        const [categories, setCategories] = useState(() => {
          const saved = localStorage.getItem('sn-cats');
          return saved ? JSON.parse(saved) : DEFAULT_CATEGORIES;
        });

        const [isAddModalOpen, setIsAddModalOpen] = useState(false);
        const [isSettingsOpen, setIsSettingsOpen] = useState(false);
        const [newItemName, setNewItemName] = useState('');
        const [newItemQuantity, setNewItemQuantity] = useState('');
        const [newItemCategory, setNewItemCategory] = useState(categories[0]);
        const [searchQuery, setSearchQuery] = useState('');
        const [aiResponse, setAiResponse] = useState(null);

        useEffect(() => localStorage.setItem('sn-data', JSON.stringify(products)), [products]);
        useEffect(() => localStorage.setItem('sn-cats', JSON.stringify(categories)), [categories]);

        const addProduct = (e) => {
          e.preventDefault();
          if (!newItemName.trim()) return;
          const newProduct = {
            id: crypto.randomUUID(),
            name: newItemName.trim(),
            quantity: newItemQuantity.trim() || undefined,
            category: newItemCategory,
            status: 'needed',
          };
          setProducts([...products, newProduct]);
          setNewItemName('');
          setNewItemQuantity('');
          setIsAddModalOpen(false);
        };

        const toggleStatus = (id) => {
          setProducts(products.map(p => p.id === id ? { ...p, status: p.status === 'needed' ? 'stocked' : 'needed' } : p));
        };

        const deleteProduct = (id) => {
          if (confirm('Zmazať položku?')) setProducts(products.filter(p => p.id !== id));
        };

        const handleAISearch = async () => {
          if (!searchQuery) return;
          try {
            const ai = new GoogleGenAI({ apiKey: (window.process?.env?.API_KEY || "") });
            const response = await ai.models.generateContent({
              model: 'gemini-3-flash-preview',
              contents: `Čo uvariť z: ${searchQuery}? Máme aj: ${products.filter(p => p.status === 'stocked').map(p => p.name).join(', ')}. Odpovedaj stručne slovensky.`,
              config: { tools: [{ googleSearch: {} }] }
            });
            setAiResponse(response.text || "");
          } catch (error) { alert("AI momentálne nedostupná."); }
        };

        const grouped = useMemo(() => {
          let filtered = activeTab === 'shopping' ? products.filter(p => p.status === 'needed') : products;
          if (searchQuery) filtered = filtered.filter(p => p.name.toLowerCase().includes(searchQuery.toLowerCase()));
          const g = {};
          filtered.forEach(p => {
            if (!g[p.category]) g[p.category] = [];
            g[p.category].push(p);
          });
          return g;
        }, [activeTab, products, searchQuery]);

        return (
          <div className="flex flex-col h-screen overflow-hidden">
            <header className="bg-emerald-600 text-white p-4 shadow-lg shrink-0 safe-top">
              <div className="flex justify-between items-center mb-4">
                <h1 className="text-xl font-bold">Nákupníček</h1>
                <button onClick={() => setIsSettingsOpen(true)} className="p-2 active:opacity-50"><Lucide.Settings size={22} /></button>
              </div>
              <div className="flex gap-2">
                <input 
                  className="flex-1 bg-emerald-700 p-2 rounded-xl text-sm outline-none placeholder-emerald-200 text-white"
                  placeholder="Hľadať / Recepty..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)}
                />
                <button onClick={handleAISearch} className="bg-emerald-500 p-2 rounded-xl active:bg-emerald-400"><Lucide.ChefHat size={22} /></button>
              </div>
            </header>

            <main className="flex-1 overflow-y-auto p-4 pb-28">
              {aiResponse && (
                <div className="bg-white p-4 rounded-2xl border border-emerald-100 mb-4 text-sm relative shadow-sm">
                  <button onClick={() => setAiResponse(null)} className="absolute top-2 right-2 text-gray-400"><Lucide.X size={16} /></button>
                  <p className="text-emerald-700 font-bold mb-1 italic">Tip od šéfkuchára:</p>
                  <p className="text-gray-700 leading-relaxed">{aiResponse}</p>
                </div>
              )}
              {Object.keys(grouped).length === 0 ? (
                <div className="text-center py-20 text-gray-400 italic text-sm">Zoznam je prázdny.</div>
              ) : (
                Object.entries(grouped).map(([cat, items]) => (
                  <div key={cat} className="mb-6">
                    <h2 className="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2 ml-1">{cat}</h2>
                    <div className="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100">
                      {items.map(p => (
                        <div key={p.id} onClick={() => toggleStatus(p.id)} className="flex items-center justify-between p-4 border-b border-gray-50 last:border-0 active:bg-gray-50">
                          <div className="flex items-center gap-3">
                            <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${p.status === 'stocked' ? 'bg-emerald-500 border-emerald-500' : 'border-gray-200'}`}>
                              {p.status === 'stocked' && <Lucide.Check size={14} className="text-white" />}
                            </div>
                            <span className={`text-base ${p.status === 'stocked' && activeTab === 'inventory' ? 'line-through text-gray-300' : 'text-gray-700'}`}>{p.name}</span>
                          </div>
                          <div className="flex items-center gap-3">
                            {p.quantity && <span className="text-[10px] font-bold bg-emerald-50 text-emerald-700 px-2 py-1 rounded-lg">{p.quantity}</span>}
                            {activeTab === 'inventory' && <button onClick={(e) => { e.stopPropagation(); deleteProduct(p.id); }} className="text-gray-300"><Lucide.Trash2 size={18} /></button>}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                ))
              )}
            </main>

            <button onClick={() => setIsAddModalOpen(true)} className="fixed bottom-24 right-6 bg-emerald-600 text-white p-4 rounded-full shadow-2xl active:scale-90 transition-transform"><Lucide.Plus size={28} /></button>

            <nav className="fixed bottom-0 w-full bg-white border-t border-gray-100 flex h-20 pb-4">
              <button onClick={() => setActiveTab('shopping')} className={`flex-1 flex flex-col items-center justify-center transition-colors ${activeTab === 'shopping' ? 'text-emerald-600' : 'text-gray-300'}`}>
                <Lucide.ShoppingCart size={24} /><span className="text-[10px] mt-1 font-bold">Nákup</span>
              </button>
              <button onClick={() => setActiveTab('inventory')} className={`flex-1 flex flex-col items-center justify-center transition-colors ${activeTab === 'inventory' ? 'text-emerald-600' : 'text-gray-300'}`}>
                <Lucide.List size={24} /><span className="text-[10px] mt-1 font-bold">Špajza</span>
              </button>
            </nav>

            {isAddModalOpen && (
              <div className="fixed inset-0 bg-black/60 z-50 flex items-end" onClick={() => setIsAddModalOpen(false)}>
                <div className="bg-white w-full rounded-t-[2.5rem] p-8 shadow-2xl" onClick={e => e.stopPropagation()}>
                  <div className="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
                  <h2 className="text-xl font-bold mb-6">Pridať do zoznamu</h2>
                  <form onSubmit={addProduct} className="space-y-4">
                    <div className="flex gap-2">
                      <input autoFocus className="flex-[2] bg-gray-50 p-4 rounded-2xl outline-none focus:ring-2 focus:ring-emerald-500 transition-all" placeholder="Názov položky..." value={newItemName} onChange={e => setNewItemName(e.target.value)} />
                      <input className="flex-1 bg-gray-50 p-4 rounded-2xl outline-none" placeholder="Množstvo" value={newItemQuantity} onChange={e => setNewItemQuantity(e.target.value)} />
                    </div>
                    <select className="w-full bg-gray-50 p-4 rounded-2xl outline-none appearance-none" value={newItemCategory} onChange={e => setNewItemCategory(e.target.value)}>
                      {categories.map(c => <option key={c} value={c}>{c}</option>)}
                    </select>
                    <button type="submit" className="w-full bg-emerald-600 text-white py-4 rounded-2xl font-bold text-lg shadow-lg active:bg-emerald-700">Pridať položku</button>
                  </form>
                </div>
              </div>
            )}

            {isSettingsOpen && (
              <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" onClick={() => setIsSettingsOpen(false)}>
                <div className="bg-white w-full max-w-md rounded-[2rem] p-8" onClick={e => e.stopPropagation()}>
                  <div className="flex justify-between items-center mb-6">
                    <h2 className="text-xl font-bold">Nastavenia</h2>
                    <button onClick={() => setIsSettingsOpen(false)} className="p-2"><Lucide.X size={24} /></button>
                  </div>
                  <div className="space-y-6">
                    <button onClick={() => { localStorage.clear(); location.reload(); }} className="w-full flex items-center justify-center gap-2 text-red-500 font-bold p-4 bg-red-50 rounded-2xl active:bg-red-100">
                      <Lucide.Trash2 size={20} /> Vymazať všetky dáta
                    </button>
                    <p className="text-[10px] text-gray-400 text-center uppercase tracking-widest">Nákupníček v1.2</p>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      }

      const rootElement = document.getElementById('root');
      if (rootElement) {
        createRoot(rootElement).render(<App />);
      }
    </script>
    <script type="module" src="https://esm.sh/run"></script>
  </body>
</html>